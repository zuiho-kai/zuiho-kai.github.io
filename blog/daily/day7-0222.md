# Day 7 — M6.2 全量代码走读 + 原型评估

> 2026-02-22 · M6.2 P1-P4

开发进入收尾阶段，今天对 M6.2 四个子阶段做了完整的代码走读，并做了一次原型需求差距评估。

## P1 记忆提取 — 从截断变 LLM 摘要

之前的记忆提取就是 `conversation[:200]` 截断，现在主路径走 `_llm_summarize()`：

- 最近 5 轮对话拼成文本，发给 gemma-3-12b，prompt 要求"提取关键事实、偏好、承诺、决定，忽略寒暄，100 字以内"
- 主供应商超时 15s 自动切备用 qwen2.5-7b，全挂才走截断兜底
- LLM 返回"无有效记忆"时直接跳过保存 — 之前截断模式下"哈哈""嗯嗯""好的"也会存一条垃圾记忆，现在不会了
- 整个调用 fire-and-forget，丢进 `_background_tasks` set 不 await，用户响应延迟零影响

实际效果：Agent 聊了"Alice 说磨坊今天产量翻倍了，Bob 说那小麦价格要跌，两人约好明天一起去集市看看"。之前存的是原文截断，现在存的是"Alice 和 Bob 注意到磨坊产量翻倍，预期小麦价格下跌，约定明天去集市"。后续检索"小麦价格"或"集市"都能命中。

## P2 SOUL 深度人格 — 从一句话到结构化 prompt

之前 Agent 人格就是一句话描述，现在支持结构化的 personality_json：

- 有 personality_json 走 SOUL_PROMPT_TEMPLATE，没有走原模板
- `_build_soul_block()` 把 dict 格式化成：核心价值观、说话风格、擅长领域、情感倾向、口头禅、对其他成员的态度、行为禁区
- relationships 字段的实际作用：Agent 提到特定人时，LLM 参考关系设定调整语气。矿工老张说"我又没钱了"，面包师不会冷冰冰回"那不能卖给你"，而是"又赊账？行吧老规矩记着"
- 缓存刷新：personality_json 变更时原地更新 runner，不用旧缓存（CR 修出来的 bug）

## P3 悬赏自主接取 — Agent 能自己看悬赏板并抢单

之前悬赏发了就躺在那里没人主动接，现在 Agent 能自主判断并抢单：

- 世界快照新增第 11 板块，每小时 tick 时 LLM 看到开放/进行中悬赏列表
- SYSTEM_PROMPT 约束：同时只能接一个，接取前考虑自身能力和竞争概率
- CAS 实现：一条 UPDATE 同时检查悬赏 open + 无人抢 + Agent 无进行中悬赏，rowcount==0 时查原因区分"被抢了"vs"你已有悬赏"

实际效果：农夫 Agent 在 tick 时看到"收集 50 小麦"悬赏，自己有 80 小麦，LLM 判断有能力完成就输出 claim_bounty。如果矿工 Agent 同一秒也想接，CAS 保证只有一个成功。

## P4 公共记忆种子数据

社区启动时需要一些"常识" — 所有 Agent 共享的基础知识。填充了 13 条种子数据：

- 经济系统（信用点、打卡收入）
- 生产链（农田→小麦→磨坊→面粉）
- 社区公约
- 属性系统（饱腹度/心情/体力）

技术实现：
- `seed_public_memories()` 函数，启动时按 content 差集插入
- begin_nested() 包裹每条 — 某条 embedding API 失败不影响其他，下次重启自动补全

UT 9/9 + ST 3/3 + 全量 266/266 全绿。CR 二次通过 P0=0 P1=0。

## 缺口

- 种子数据第 8 条写了"短期记忆自动升级为长期记忆"，但代码里没有升级机制 — 这是最大的功能性缺口
- 悬赏自动验证未做，只有接取没有交付闭环

## 原型完成度评估

| 模块 | 完成度 |
|------|--------|
| 多 Agent 聊天群 | 100% |
| 唤醒机制 | 100% |
| 发言频率控制 | 100% |
| 信用点经济 | 100% |
| 页游城市 | 95% |
| 公共记忆 | 95% |
| Agent 独立人格 | 90% |
| 短期/长期记忆 | 90% |
| 悬赏任务 | 70% |

**整体原型完成度约 85%**。核心功能全部可用，剩余的主要是锦上添花（游戏币、模型切换、皮肤装饰）和体验优化（悬赏前端、记忆自动升级）。

## 7 天回顾

从 2 月 15 日到 2 月 22 日，7 天时间：

- 12 个里程碑完成
- 266 个测试全绿
- 从零到一个 85% 完成度的 AI 社区原型

核心能力全部就位：Agent 能聊天、能记忆、能赚钱花钱、能自主行动、能交易建造、能上网查资料。

接下来的方向：悬赏前端集成、记忆自动升级、深度人格系统，以及最终目标 — PixiJS 2D 地图。
